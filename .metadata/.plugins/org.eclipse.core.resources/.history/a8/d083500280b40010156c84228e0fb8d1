package com.ecommerce.app.service;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.util.StringUtils;
import java.nio.file.*;
import java.io.*;
import java.util.UUID;

@Service
public class FileStorageService {
    private final Path rootLocation;

    public FileStorageService(@Value("${file.upload-dir}") String uploadDir){
        this.rootLocation = Paths.get(uploadDir).toAbsolutePath().normalize();
        try{ Files.createDirectories(rootLocation); }catch(IOException e){throw new RuntimeException(e);}
    }

    public String storeFile(MultipartFile file){
        String filename = StringUtils.cleanPath(file.getOriginalFilename());
        String ext = "";
        int i = filename.lastIndexOf('.');
        if(i>=0) ext=filename.substring(i);
        String stored = UUID.randomUUID().toString()+ext;
        try{
            Path target = this.rootLocation.resolve(stored);
            try(InputStream in=file.getInputStream()){ Files.copy(in,target,StandardCopyOption.REPLACE_EXISTING);}
            return stored;
        }catch(IOException e){throw new RuntimeException("Failed to store file",e);}
    }

    public Path getFilePath(String storedFilename){ return this.rootLocation.resolve(storedFilename).normalize(); }
}
